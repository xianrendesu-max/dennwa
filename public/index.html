<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä»™äººé›»è©±</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body {
  margin:0;
  font-family: system-ui, sans-serif;
  background:#000;
  color:#fff;
}
header {
  padding:15px;
  text-align:center;
  font-size:18px;
  background:#111;
}
.screen {
  padding:20px;
  text-align:center;
}
.number {
  font-size:24px;
  margin:10px 0;
}
input {
  font-size:22px;
  width:80%;
  padding:10px;
  text-align:center;
  border-radius:10px;
  border:none;
}
.buttons {
  margin-top:20px;
}
.btn {
  width:80px;
  height:80px;
  border-radius:50%;
  font-size:22px;
  border:none;
  margin:10px;
}
.call { background:#00c853; }
.end { background:#d50000; }
.hidden { display:none; }

#timer {
  font-size:20px;
  margin-top:10px;
}

.history {
  text-align:left;
  margin-top:20px;
}
.history li {
  padding:8px;
  border-bottom:1px solid #333;
  font-size:14px;
}
</style>
</head>
<body>

<header>ä»™äººé›»è©±</header>

<div class="screen" id="main">
  <div>ã‚ãªãŸã®ç•ªå·</div>
  <div class="number" id="myNumber"></div>

  <input id="callTo" placeholder="ç›¸æ‰‹ã®ç•ªå·">
  <div class="buttons">
    <button class="btn call" onclick="call()">ğŸ“</button>
  </div>

  <div class="history">
    <h3>é€šè©±å±¥æ­´</h3>
    <ul id="history"></ul>
  </div>
</div>

<div class="screen hidden" id="calling">
  <h2 id="callText"></h2>
  <div id="timer">00:00</div>
  <div class="buttons">
    <button class="btn end" onclick="hangup()">âŒ</button>
  </div>
</div>

<audio id="remote" autoplay></audio>
<audio id="ring" loop src="ring.mp3"></audio>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const ws = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://") + location.host
);
const pc = new RTCPeerConnection();
const remote = document.getElementById("remote");
const ring = document.getElementById("ring");

let target = null;
let timerId = null;
let sec = 0;

/* ===== å›ºæœ‰ç•ªå· ===== */
let myNumber = localStorage.getItem("myNumber");
if (!myNumber) {
  myNumber = "7" + Math.floor(1000000 + Math.random() * 9000000);
  localStorage.setItem("myNumber", myNumber);
}
document.getElementById("myNumber").innerText = myNumber;

/* ===== WebSocket ===== */
ws.onopen = () => {
  ws.send(JSON.stringify({ type:"register", number:myNumber }));
};

ws.onmessage = async e => {
  const d = JSON.parse(e.data);

  if (d.type === "incoming") {
    target = d.from;
    ring.play();
    showCalling(`${d.from} ã‹ã‚‰ç€ä¿¡`);
    saveHistory("ç€ä¿¡", d.from);
  }

  if (d.offer) {
    await pc.setRemoteDescription(d.offer);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    ws.send(JSON.stringify({ type:"signal", answer:ans, to:target }));
    startTimer();
  }

  if (d.answer) {
    await pc.setRemoteDescription(d.answer);
    startTimer();
  }

  if (d.ice) await pc.addIceCandidate(d.ice);
};

/* ===== WebRTC ===== */
pc.ontrack = e => remote.srcObject = e.streams[0];
pc.onicecandidate = e => {
  if (e.candidate)
    ws.send(JSON.stringify({ type:"signal", ice:e.candidate, to:target }));
};

/* ===== ç™ºä¿¡ ===== */
async function call() {
  target = callTo.value;
  showCalling(`${target} ã«ç™ºä¿¡ä¸­`);
  saveHistory("ç™ºä¿¡", target);

  ws.send(JSON.stringify({ type:"call", to:target }));

  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type:"signal", offer, to:target }));
}

/* ===== åˆ‡æ–­ ===== */
function hangup() {
  stopTimer();
  pc.close();
  location.reload(); // ç°¡æ˜“ãƒªã‚»ãƒƒãƒˆ
}

/* ===== UIåˆ¶å¾¡ ===== */
function showCalling(text) {
  document.getElementById("main").classList.add("hidden");
  document.getElementById("calling").classList.remove("hidden");
  document.getElementById("callText").innerText = text;
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼ ===== */
function startTimer() {
  ring.pause();
  timerId = setInterval(() => {
    sec++;
    const m = String(Math.floor(sec / 60)).padStart(2,"0");
    const s = String(sec % 60).padStart(2,"0");
    timer.innerText = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  clearInterval(timerId);
  sec = 0;
}

/* ===== å±¥æ­´ ===== */
function saveHistory(type, num) {
  const h = JSON.parse(localStorage.getItem("history") || "[]");
  h.unshift({ type, num, time:new Date().toLocaleString() });
  localStorage.setItem("history", JSON.stringify(h));
  loadHistory();
}

function loadHistory() {
  const h = JSON.parse(localStorage.getItem("history") || "[]");
  history.innerHTML = h.map(i =>
    `<li>${i.time}ï½œ${i.type}ï½œ${i.num}</li>`
  ).join("");
}
loadHistory();
</script>

</body>
</html>
